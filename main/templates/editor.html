{% extends 'base.html' %}
{% load static %}

{% block 'title' %}
    Создание трека
{% endblock %}

{% block 'head' %}
    <link rel="stylesheet" type="text/css" href="{% static 'styles/editor.css' %}">
{% endblock %}

{% block 'body' %}
    <div class="centered" style="width: 90vw; height: 900px;">
        <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="display: flex; height: 100%; overflow: hidden;">
                <div class="scrollbar scrollbar-vertical"><div class="scrollbar-thumb"></div></div>
                <div style="overflow-y: hidden;">
                    <div style="display: flex; align-items: flex-start;">
                        <canvas id="notes"></canvas>
                        <div style="overflow-x: hidden;">
                            <canvas id="track">Ваш браузер не поддерживает canvas :/</canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="scrollbar scrollbar-horizontal"><div class="scrollbar-thumb"></div></div>
        </div>
    </div>
{% endblock %}

{% block 'scripts' %}
    <script src="{% static 'libs/Pizzicato.min.js' %}"></script>
    <script src="{% static 'scripts/grid.js' %}"></script>
    <script src="{% static 'scripts/canvasGrid.js' %}"></script>
    <script src="{% static 'scripts/canvasGridDrawer.js' %}"></script>
    <script src="{% static 'scripts/scrollbarThumb.js' %}"></script>
    <script src="{% static 'scripts/musicNotes.js' %}"></script>
    <script>
        const notesCanvas = document.getElementById("notes");
        const trackCanvas = document.getElementById("track");
        if (!(trackCanvas.getContext && notesCanvas.getContext)) {
            throw new Error("canvas is not supported");
        }
        
        const notes = getMusicNotes();

        const notesCheatsheet = new CanvasGrid(notesCanvas, 1, notes.length, 50, 25, {
            readonly: true,
            emptyColor: 'lightgray'
        });

        const notesCtx = notesCanvas.getContext('2d');

        function drawNoteNames() {
            notesCtx.font = '25px Consolas';
            notesCtx.fillStyle = 'black';
            for (let i = 0; i < notes.length; i++) {
                notesCtx.fillText(notes[i][0], 4, i * notesCheatsheet.cellHeight + 21);
            }
        }

        drawNoteNames();

        const track = new CanvasGrid(trackCanvas, 100, notes.length, 50, 25, {
            toggledColor: '#ff173e'
        });

        const thumbs = document.getElementsByClassName("scrollbar-thumb");
        new ScrollbarThumb(thumbs[0], notesCanvas.parentElement.parentElement);
        new ScrollbarThumb(thumbs[1], trackCanvas.parentElement);

        window.onresize = () => {
            notesCanvas.onresize();
            drawNoteNames();
            trackCanvas.onresize();
        }

        window.onload = () => {
            let audioContext;
            let sineWave = new Pizzicato.Sound({ 
                source: 'wave', 
            });

            sineWave.attack = 0.2;
            sineWave.release = 1;
            sineWave.volume = 0.1;

            track.oncellupdate = (x, y, value) => {
                if (value) {
                    if (!audioContext) {
                        audioContext = new AudioContext();
                    }

                    const note = notes[y];
                    sineWave.frequency = note[1];

                    sineWave.play();
                }
            }

            track.drawer.onenddraw = () => {
                sineWave.stop();
            }
        }
    </script>
{% endblock %}