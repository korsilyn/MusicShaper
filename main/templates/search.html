{% extends 'base.html' %}
{% load static %}

{% block 'title' %}Поиск{% endblock %}

{% block 'body' %}
    <br>
    <div class="text-center">
        <h2>ПОИСК</h2><br>
        <div class="form-group">
            <input type="search" placeholder='Введите ваш запрос' class="form-control" id='search' required>
        </div>
        <div class="form-group">
            <label>Искать по:</label>
            <select id="filter">
                <option value="user" selected>Пользователям</option>
                <option value="track">Трекам</option>
            </select>
        </div>
        <div class="text-center">
            <button onclick="ajax_request()" class="btn btn-primary">Искать</button>
        </div>
    </div>
    <br>
    <ul class="list-group" id='result'>
        
    </ul>
{% endblock %}
{% block 'scripts' %}
<script>
    function ajax_request() {
        if (!document.getElementById("search").value) return;
        const filter = document.getElementById("filter").value;
        $.ajax({
            url: "{% url 'search' %}",
            dataType: "json",
            method: "POST",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                filter,
                query: document.getElementById("search").value,
            },
            success: (data) => {
                const elul = document.getElementById('result');
                elul.innerHTML = '';
                if (data.filtered.length > 0){
                    for (const v of data.filtered) {
                        const el = document.createElement('li');
                        elul.appendChild(el);
                        el.classList.add('list-group-item');
                        if (filter == 'user') {
                            el.innerHTML = `<img class="rounded-circle" width="40px" height="40px" src="${v.image ? v.image : `{% static 'img/default_avatar.jpg'  %}`}">
                            <b>${v.username}</b>
                            <i><small>${v.status}</i></small>`;
                        }
                        else if (filter == 'track') {
                            el.innerHTML = `<b>${v.name}</b>`;
                        }
                    }
                }
                else {
                    const el = document.createElement('div');
                    elul.appendChild(el);
                    el.classList.add('text-center')
                    el.innerHTML = `<i>Ничего не найдено</i>`
                }
            },
            error: (error, _status, _thrownErr) => {
                alert(error.responseText);
            },
        })
    }
</script>
{% endblock %}