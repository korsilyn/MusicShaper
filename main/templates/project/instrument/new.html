{% extends 'base.html' %}
{% load static %}

{% block 'title' %}
    Создание инструмента
{% endblock %}

{% block 'head' %}
    <link rel="stylesheet" href="{% static 'styles/piano.css' %}">
    <style>
        .card {
            padding: 30px;
        }

        .card > .card, .card > #synthSettings > .card {
            margin: 15px;
        }

        #octaveInputDiv {
            max-width: 40%;
        }

        .piano {
            margin-bottom: 30px;
        }
    </style>
{% endblock %}

{% block 'body' %}
    <div class="margin-top-5"></div>
    <div class="text-center">
        <h2>Создание инструмента</h2>
        <a href="{% url 'instruments' id=project.id %}">
            Назад к списку инструментов
        </a>
    </div>
    <div class="margin-top-5"></div>

    <div id="octaveInputDiv" class="form-group mx-auto">
        <label>Октава (от 2 до 7)</label>
        <input id="octaveInput" class="form-control"
            type="number" min="2" max="7" value="4">
    </div>
    
    {% include 'project/piano.html' %}

    <div class="form-group">
        <label>Тип инструмента</label>
        <select id="synthSelector" class="form-control">
            <option value="null" selected>Не выбран</option>
        </select>
    </div>

    <div id="settingsCollapse" class="collapse">
        <div id="synthSettings" class="card"></div>
    </div>
{% endblock %}

{% block 'scripts' %}
    <script src="{% static 'libs/Tone.js' %}"></script>
    <script src="{% static 'scripts/musicNotes.js' %}"></script>
    <script>
        (function() {

        // #region options menu

        const defaults = JSON.parse(`{{ instrumentDefaults|safe|escapejs }}`);
        
        function translate(value, lang="ru") {
            return defaults.translations[lang][value] || value; 
        }

        const synthSelector = document.getElementById('synthSelector');
        const settingsDiv = document.getElementById('synthSettings');

        // instrument type select
        for (const synthName in defaults.settings.synths) {
            const newOption = document.createElement("option");
            newOption.value = synthName;
            newOption.innerHTML = translate(synthName);

            synthSelector.appendChild(newOption);
        }

        function placeNumberSetting(name, [_default, min=undefined, max=undefined]) {
            const formGroup = document.createElement("div");
            formGroup.classList.add("form-group");

            const inputLabel = document.createElement("label");
            inputLabel.innerHTML = translate(name);

            formGroup.appendChild(inputLabel);

            const numberInput = document.createElement("input");
            numberInput.classList.add("form-control");
            numberInput.type = "number";

            numberInput.value = _default;
            numberInput.step = 0.1;
            if (min !== undefined) numberInput.min = min;
            if (max !== undefined) numberInput.max = max;

            formGroup.appendChild(numberInput);
            return formGroup;
        }

        function placeSelectSetting(name, options) {
            const formGroup = document.createElement("div");
            formGroup.classList.add("form-group");

            const selectLabel = document.createElement("label");
            selectLabel.innerHTML = translate(name);

            formGroup.appendChild(selectLabel);

            const selectEl = document.createElement("select");
            selectEl.classList.add("form-control");

            for (const option of options) {
                const optionEl = document.createElement("option");
                optionEl.value = option;
                optionEl.innerHTML = translate(option);

                selectEl.appendChild(optionEl);
            }

            formGroup.appendChild(selectEl);
            return formGroup;
        }

        function placeSettingsObj(settings, div) {
            for (const [key, value] of Object.entries(settings)) {
                if (value instanceof Array) {
                    const valueType = typeof value[0];
                    if (valueType == "number") {
                        div.appendChild(placeNumberSetting(key, value));
                    }
                    else if (valueType == "string") {
                        div.appendChild(placeSelectSetting(key, value));
                    }
                    else {
                        console.error(`not supported setting type ${valueType}`);
                    }
                }
                else {
                    const cardDiv = document.createElement("div");
                    cardDiv.classList.add("card");

                    const header = document.createElement("h5");
                    header.innerHTML = translate(key);
                    cardDiv.appendChild(header);

                    placeSettingsObj(value, cardDiv);
                    div.appendChild(cardDiv);
                }
            }
        }

        synthSelector.onchange = ({ srcElement: { value: synthName } }) => {
            settingsDiv.innerHTML = "";
            if (synthName != "null") {
                placeSettingsObj(defaults.settings.synths[synthName], settingsDiv);
                $('#settingsCollapse').collapse('show');
            }
            else {
                $('#settingsCollapse').collapse('hide');
            }
        }

        // #endregion

        // #region piano

        let synth = new Tone.Synth();
        synth.toMaster();

        let isSynthPlaying = false;

        let octave = 0;
        const octaveInput = document.getElementById('octaveInput');
        octaveInput.onchange = () => octave = octaveInput.value;

        octaveInput.onchange();

        function activateKey(key) {
            key.classList.add('active');
        }

        function deactivateKey(key) {
            key.classList.remove('active');
        }

        function playKey(key) {
            activateKey(key);
            const note = key.attributes.getNamedItem('note').value;
            if (!isSynthPlaying) {
                synth.triggerAttack(note + octave);
                isSynthPlaying = true;
            }
            else {
                synth.setNote(note + octave);
            }
        }

        function stopPlaying() {
            synth.triggerRelease();
            isSynthPlaying = false;
            lastKey = null;
            for (const key of document.querySelectorAll(".key.active")) {
                deactivateKey(key);
            }
        }

        const pianoKeys = document.querySelectorAll(".key");

        let lastKey = null;
        for (const key of pianoKeys) {
            const playEv = ({ which }) => {
                if (which != 0) {
                    if (lastKey && lastKey != key) {
                        deactivateKey(lastKey);
                    }
                    playKey(key);
                    lastKey = key;
                }
            };

            key.addEventListener('mousedown', playEv);
            key.addEventListener('mousemove', playEv);
        }

        window.addEventListener('mouseup', stopPlaying);

        const whitePianoKeys = document.querySelectorAll(".key.white");
        const blackPianoKeys = document.querySelectorAll(".key.black");

        const whiteKeys = ['z', 'x', 'c', 'v', 'b', 'n', 'm'];
        const blackKeys = ['s', 'd', 'g', 'h', 'j'];

        window.addEventListener('keydown', ev => {
            const key = ev.code.replace('Key', '').toLowerCase();
            const whiteKeyIndex = whiteKeys.indexOf(key);
            const blackKeyIndex = blackKeys.indexOf(key);

            if (whiteKeyIndex > -1) playKey(whitePianoKeys.item(whiteKeyIndex));
            if (blackKeyIndex > -1) playKey(blackPianoKeys.item(blackKeyIndex));
        }, true);

        window.addEventListener('keyup', ev => {
            const key = ev.code.replace('Key', '').toLowerCase();
            const whiteKeyIndex = whiteKeys.indexOf(key);
            const blackKeyIndex = blackKeys.indexOf(key);

            if (whiteKeyIndex > -1 || blackKeyIndex > -1) {
                stopPlaying();
            }
        });

        // #endregion

        })();
    </script>
{% endblock %}